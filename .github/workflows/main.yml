name: CI/CD Workflow

on:
  push:
    branches:
      - 'feature/**'
      - main
      - dev
  pull_request:
    branches:
      - dev

jobs:
  deploy:
    name: Build & Deploy to EC2
    runs-on: ubuntu-latest
    env:
      FIREBASE_SERVICE: ${{ secrets.FIREBASE_SERVICE }}

    steps:
      - name: âœ… Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Create env.properties
        run: |
          mkdir -p src/main/resources/properties
          echo "${{ secrets.ENV }}" > src/main/resources/properties/.env.properties

      - name: ğŸ” Create Firebase service JSON
        run: |
          mkdir -p src/main/resources/config
          echo '${{ secrets.FIREBASE_SERVICE }}' > src/main/resources/config/firebase-service.json

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: ğŸ”§ Install Maven
        run: |
          sudo apt-get update -y
          sudo apt-get install -y maven
          mvn -v

      - name: ğŸ§± Build Application (skip tests)
        run: mvn clean package -DskipTests

      - name: ğŸš€ Deploy to EC2
        env:
          AWS_URL: ${{ secrets.AWS_URL }}
          AWS_KEY: ${{ secrets.AWS_KEY }}
        run: |
          echo "âš™ï¸ Setting up SSH..."
          mkdir -p ~/.ssh
          echo "$AWS_KEY" > ~/.ssh/aws_key.pem
          chmod 600 ~/.ssh/aws_key.pem
          ssh-keyscan -H "$AWS_URL" >> ~/.ssh/known_hosts

          JAR_NAME=$(ls target/*.jar | head -n 1)
          echo "ğŸ“¦ ë¹Œë“œëœ JAR: $JAR_NAME"

          echo "ğŸ“¡ EC2ë¡œ ì—…ë¡œë“œ ì¤‘..."
          scp -i ~/.ssh/aws_key.pem "$JAR_NAME" ubuntu@"$AWS_URL":/home/ubuntu/app.jar

          echo "ğŸš€ ì„œë²„ì—ì„œ ì‹¤í–‰ ì¤‘..."
          ssh -t -i ~/.ssh/aws_key.pem ubuntu@"$AWS_URL" << 'EOF'
            set -e
            echo "ğŸ›‘ ê¸°ì¡´ ì•± ì¢…ë£Œ ì‹œë„..."
            PID=$(pgrep -f "app.jar" || true)
            if [ -n "$PID" ]; then
              echo "ğŸ”ª ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ: $PID"
              kill -9 $PID
            fi

            echo "ğŸš€ ìƒˆ ë²„ì „ ì‹¤í–‰ ì¤‘..."
            nohup java -jar /home/ubuntu/app.jar > /home/ubuntu/app.log 2>&1 &

            sleep 5
            echo "âœ… ì•± ì‹¤í–‰ ì™„ë£Œ! ìµœê·¼ ë¡œê·¸:"
            tail -n 15 /home/ubuntu/app.log
          EOF